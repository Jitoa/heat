# heat
塚原研伝熱コード

## ETIME
ETIME は(非標準の)経過 CPU 時間を取得するタイミング用サブルーチン．
CALL ETIME(WT1) で実行開始時の CPU 時間を WT1 に記録し，途中で WT2, WT3, 最後に WT4 を記録，最後に WRITE 文で (WT4-WT1) を計算して全体の経過 CPU 時間(秒)を表示．

## NN
NN は計算全体の「総合タイムステップ（グローバル時間ステップ）カウンタ」．最初に 0 に初期化され、時間を進める各ステップで NN=NN+1 される．
この値を使って10 ステップ毎の処理```IF (MOD(NN,10).EQ.0) …```<br>
500 ステップ毎の統計・平均処理```IF (MOD(NN,500).EQ.0) …```といった出力や統計更新のタイミング制御．

## NUM
速度場 (U,P 等) を時間積分した回数＝「速度を更新したステップ数」

## NCALC 
温度場 (スカラ場) を時間積分した回数＝「温度を更新したステップ数」

## NAVE
「時間平均（統計）サンプルの取得回数カウンタ」.<br>
初期化 (NAVE=0) 後、条件 IF (MOD(NN,500).EQ.0) に入ったとき NAVE=NAVE+1 され、そのタイミングで CALL AVE(NN) や CALL BUDGET など平均・統計更新が実行.

## AVETIM 
「速度場の時間平均に使う有効積算物理時間．<br>
平均量正規化: ```AVE``` や ```BUDGET``` 等のサブルーチン内部で，累積した瞬時値の積分（∑(量)·Δt）を```AVETIM``` で割って時間平均を求める分母になる．
収束/十分性判断: 出力行 (WRITE で TIME と並べて表示) を見て，どれだけ平均時間を蓄積したかを監視し，統計が安定したか判断．
再スタート管理: ```AVEOUT / AVEIN``` により途中から再開する際，既に蓄積した平均時間として保存/読込され，平均の継続性を保つ．

## CALTIM
温度場（スカラー場）に関する時間平均用の累積物理時間．速度場用 AVETIM と対になる「温度専用タイムカウンタ」．

## NSTCS
温度場の「周期的な詳細統計（secondary / short-time statistics）」を何回収集したかを数えるサンプル回数カウンタ．<br>
温度場の周期統計サンプル数インデックスで，500 ステップごとの``` STCS 系統計```を「第何回目か」管理するためのカウンタ

## STCSTM
温度場の「短周期／詳細統計 (STCS 系)」用に積み上げる物理経過時間．対応するカウンタ  ```NSTCS（サンプル回数） ```に対し， ```STCSTM ``` はその統計が覆う合計時間長を与える

## JA,JB,JC,JD,JE,JF,JH,JI,JJ,JK,JL
壁面法線方向 (y 方向) の格子インデックス（J 番号）の中から代表的な位置を選んで保持する “参照ポイント集合” 

## SEEDIN(IERR)
(再スタート機能):以前保存した計算状態（時間発展途中の速度場と関連パラメータ）をバイナリファイル群（UNIT 20–25）から読み込み，計算を途中再開できるようにする

## TSEEDIN 
温度（スカラ）場リスタート入力ルーチン．前回計算を途中で終了した時点の (1) スカラ時間ステップカウンタ NCALC (2) 温度場の累積経過時間 CALTIM (3) 2つの温度場配列 T1, T2 （本コードでは 2 スカラー or 2 つの温度成分用バッファ） をバイナリファイル(UNIT 32–35)から読み込み，内部の全領域配列 T1G, T2G に再構築.

## AVEIN 
「途中再開（リスタート）時に，これまで積算してきた速度場の時間平均統計（各種一次〜高次統計・予算・スペクトル・相関など）と，それに対応するカウンタ類 ```NAVE（平均サンプル数）, AVETIM（平均化に費やした実時間）, NFIN（これまでに計算した総ステップ換算指標）等```をバイナリファイル（装置番号 UNIT=10）から読み込み，計算を新規初期化ではなく継続平均モードに入れるためのサブルーチン」です．

## TAVEIN 
温度（スカラー）統計量の「途中再開（リスタート）用読み込み」サブルーチン．<br>
UNIT=12 (バイナリ) に AVE 相当の温度場統計（平均, RMS, フラックス, 生成/散逸/拡散/再配分の各予算項，スペクトル，二点相関，スカラーの歪度・平坦度，三重相関・クアドラント解析，条件付き出現数など）と，短周期サンプル数 NSTCS とその累積時間 STCSTM，さらに 2 系統(= T1/T2) の統計群を含む全配列を記録しており，それを完全に復元します．これにより前ジョブで蓄積した温度統計を引き継いで長時間平均を継続可能．

## ZERO
新規計算開始時に「速度場の時間平均統計データ一式」を完全リセットする初期化ルーチン。

## CLR
温度場統計の完全リセット（新規計算開始用）．時間平均用カウンタ ```NSTCS=0, STCSTM=0.0、QAVT 用カウンタ NQACT=0``` を初期化

## NFIN 
ジョブ全体で統計に寄与した累積「終了」ステップ総数を保持し，再スタート時に過去サンプル量を再構築するための履歴カウンタ．ブロック（NC ステップ）終了時に一度だけ加算され，瞬時計測用 NN/NUM やサンプリングカウンタ NAVE と役割が異なる．

## FS0
呼び出し位置 CALL FS0 はメインで 1 回だけ（初期化フェーズ: UBC → FS0 → COEF_DEM の直前）．以後は FS1 / FS2 が時間発展ステップで使われ，FS0 は再度呼ばれない「初回専用の前処理ルーチン」．
初期ステップ（fractional-step 法の最初の半ステップ）を行うために必要な作業を行う．

##  ERG_1STP 
温度 2 成分の y 方向半陰解法用係数と初回 RHS を構築し，AB2 時間積分の履歴配列を初期化して 2 ステップ目以降の ERG に滑らかに接続する “初回専用温度更新カーネル”

## CNTDMAT
温度 2 成分 T1, T2 の y 方向 Crank–Nicolson(半陰) 解法を三重対角行列 (TDMA) で解き，中間（暫定）温度場を更新するステップ．<br>
直前の ERG_1STP / ERG が作った RHS 配列 FFS1, FFS2 と、同じくそこで（初回は ERG_1STP 内）設定された係数 AAT, BBT1, BBT2, CCT を用い、各 (i,k) について y 方向 1 次元の 2 本（T1 と T2）の連立三重対角系を解く。
解後に周期方向 (x,z) と壁方向 (y) のゴースト/境界セルを埋めて温度場の境界条件を整える。

## CNTDMA 
毎ステップ，前段で組み立てられた速度 RHS (FFX,FFY,FFZ) を y 方向半陰 (三重対角) 解法で解いて暫定速度場 UT を得る fractional-step 中間ステージで，続く Poisson 解 (FS2) の入力を提供する

## FS2 
fractional-step 法の圧力 Poisson ステージ：(1) 予測場 UT の発散 → (2) スペクトル×TDMA で Poisson 解 φ → (3) 勾配補正で発散フリー速度 U → (4) 一貫した半陰的圧力 P 更新 → (5) 境界再構築。
CNTDMA が作った “時間半陰(粘性 y) + 陽的非線形” 含む暫定速度を、流体力学的拘束 (∇·U=0) に投影する最終必須段階。

## TMSRSU
瞬時の速度 (u,v,w) から各 y 面での平面平均 (x,z 平均) を計算し 1 次元プロファイル AU, AV, AW, AP を得る<br>
そのプロファイルを用いて全格子点の乱流変動成分 u', v', w' を構築 (UT 配列に格納)<br>
代表 5 個の壁法線方向位置 (JA2, JB2, JC2, JD2(≒中心高さ近傍), JE2=中心) と 4 つの spanwise 位置 (z = 1/8,3/8,5/8,7/8 *幅) の組み合わせ 5×4 = 20 点で
u', v', w' をそれぞれ時間行 (1 行が 6 列: 時刻 + 5 つの y 位置) として 20 系列 (3 成分 × 4 z スライス × 5 y) に分け複数ファイルへ APPEND 出力<br>
これにより後処理で各高度・スパン位置の時間発展（統計的独立性評価 / スペクトル解析など）が可能

## TMSRST
2 つの温度（/スカラー）場 T1,T2 の x–z 平面平均（各 y）を取り瞬時の平均プロファイル EAT1(J),EAT2(J) を作る．<br>
それを用いて温度変動 T1' = T1 - <T1>_xz, T2' = T2 - <T2>_xz を生成．<br>
代表 5 つの壁法線位置 (JA2=1, JB2=16, JC2=22, JD2=36, JE2=48) と 4 つのスパン方向位置 (z = 1/8,3/8,5/8,7/8) の 20 点で時間列を継続追記出力．<br>
後処理用（例: 個別点の自相関 / スペクトル / 熱統計の収束確認）．

## ERG(PR1,PR2)
温度（ここでは 2 つのスカラー T1,T2）方程式の「陽的（AB2）部分 + y 方向以外の拡散項」を組み立てるサブルーチン．<br>
呼び出し順序: (各時間ステップの温度更新が必要なとき)<br>
ERG_1STP → CNTDMAT （初回のみ）<br>
以後は ERG → CNTDMAT のペア.<br>
ERG は 2 段階法: ERG で RHS を作り FFS1/FFS2 に格納 → CNTDMAT が y 方向 Crank–Nicolson (TDMA) で陰的項を解き T1,T2 を前進.


