# heat
塚原研伝熱コード

## ETIME
ETIME は(非標準の)経過 CPU 時間を取得するタイミング用サブルーチン．
CALL ETIME(WT1) で実行開始時の CPU 時間を WT1 に記録し，途中で WT2, WT3, 最後に WT4 を記録，最後に WRITE 文で (WT4-WT1) を計算して全体の経過 CPU 時間(秒)を表示．

## NN
NN は計算全体の「総合タイムステップ（グローバル時間ステップ）カウンタ」．最初に 0 に初期化され、時間を進める各ステップで NN=NN+1 される．
この値を使って10 ステップ毎の処理```IF (MOD(NN,10).EQ.0) …```<br>
500 ステップ毎の統計・平均処理```IF (MOD(NN,500).EQ.0) …```といった出力や統計更新のタイミング制御．

## NUM
速度場 (U,P 等) を時間積分した回数＝「速度を更新したステップ数」

## NCALC 
温度場 (スカラ場) を時間積分した回数＝「温度を更新したステップ数」

## NAVE
「時間平均（統計）サンプルの取得回数カウンタ」.<br>
初期化 (NAVE=0) 後、条件 IF (MOD(NN,500).EQ.0) に入ったとき NAVE=NAVE+1 され、そのタイミングで CALL AVE(NN) や CALL BUDGET など平均・統計更新が実行.

## AVETIM 
「速度場の時間平均に使う有効積算物理時間．<br>
平均量正規化: ```AVE``` や ```BUDGET``` 等のサブルーチン内部で，累積した瞬時値の積分（∑(量)·Δt）を```AVETIM``` で割って時間平均を求める分母になる．
収束/十分性判断: 出力行 (WRITE で TIME と並べて表示) を見て，どれだけ平均時間を蓄積したかを監視し，統計が安定したか判断．
再スタート管理: ```AVEOUT / AVEIN``` により途中から再開する際，既に蓄積した平均時間として保存/読込され，平均の継続性を保つ．

## CALTIM
温度場（スカラー場）に関する時間平均用の累積物理時間．速度場用 AVETIM と対になる「温度専用タイムカウンタ」．

## NSTCS
温度場の「周期的な詳細統計（secondary / short-time statistics）」を何回収集したかを数えるサンプル回数カウンタ．<br>
温度場の周期統計サンプル数インデックスで，500 ステップごとの``` STCS 系統計```を「第何回目か」管理するためのカウンタ

## STCSTM
温度場の「短周期／詳細統計 (STCS 系)」用に積み上げる物理経過時間．対応するカウンタ  ```NSTCS（サンプル回数） ```に対し， ```STCSTM ``` はその統計が覆う合計時間長を与える

## JA,JB,JC,JD,JE,JF,JH,JI,JJ,JK,JL
壁面法線方向 (y 方向) の格子インデックス（J 番号）の中から代表的な位置を選んで保持する “参照ポイント集合” 

## SEEDIN(IERR)
(再スタート機能):以前保存した計算状態（時間発展途中の速度場と関連パラメータ）をバイナリファイル群（UNIT 20–25）から読み込み，計算を途中再開できるようにする

## TSEEDIN 
温度（スカラ）場リスタート入力ルーチン．前回計算を途中で終了した時点の (1) スカラ時間ステップカウンタ NCALC (2) 温度場の累積経過時間 CALTIM (3) 2つの温度場配列 T1, T2 （本コードでは 2 スカラー or 2 つの温度成分用バッファ） をバイナリファイル(UNIT 32–35)から読み込み，内部の全領域配列 T1G, T2G に再構築.

## AVEIN 
「途中再開（リスタート）時に，これまで積算してきた速度場の時間平均統計（各種一次〜高次統計・予算・スペクトル・相関など）と，それに対応するカウンタ類 ```NAVE（平均サンプル数）, AVETIM（平均化に費やした実時間）, NFIN（これまでに計算した総ステップ換算指標）等```をバイナリファイル（装置番号 UNIT=10）から読み込み，計算を新規初期化ではなく継続平均モードに入れるためのサブルーチン」です．

## TAVEIN 
温度（スカラー）統計量の「途中再開（リスタート）用読み込み」サブルーチン．<br>
UNIT=12 (バイナリ) に AVE 相当の温度場統計（平均, RMS, フラックス, 生成/散逸/拡散/再配分の各予算項，スペクトル，二点相関，スカラーの歪度・平坦度，三重相関・クアドラント解析，条件付き出現数など）と，短周期サンプル数 NSTCS とその累積時間 STCSTM，さらに 2 系統(= T1/T2) の統計群を含む全配列を記録しており，それを完全に復元します．これにより前ジョブで蓄積した温度統計を引き継いで長時間平均を継続可能．

## ZERO
新規計算開始時に「速度場の時間平均統計データ一式」を完全リセットする初期化ルーチン。

## CLR
温度場統計の完全リセット（新規計算開始用）．時間平均用カウンタ ```NSTCS=0, STCSTM=0.0、QAVT 用カウンタ NQACT=0``` を初期化

## NFIN 
ジョブ全体で統計に寄与した累積「終了」ステップ総数を保持し，再スタート時に過去サンプル量を再構築するための履歴カウンタ．ブロック（NC ステップ）終了時に一度だけ加算され，瞬時計測用 NN/NUM やサンプリングカウンタ NAVE と役割が異なる．

## FS0
呼び出し位置 CALL FS0 はメインで 1 回だけ（初期化フェーズ: UBC → FS0 → COEF_DEM の直前）．以後は FS1 / FS2 が時間発展ステップで使われ，FS0 は再度呼ばれない「初回専用の前処理ルーチン」．
初期ステップ（fractional-step 法の最初の半ステップ）を行うために必要な作業を行う．

##  ERG_1STP 
温度 2 成分の y 方向半陰解法用係数と初回 RHS を構築し，AB2 時間積分の履歴配列を初期化して 2 ステップ目以降の ERG に滑らかに接続する “初回専用温度更新カーネル”

## CNTDMAT
温度 2 成分 T1, T2 の y 方向 Crank–Nicolson(半陰) 解法を三重対角行列 (TDMA) で解き，中間（暫定）温度場を更新するステップ．<br>
直前の ERG_1STP / ERG が作った RHS 配列 FFS1, FFS2 と、同じくそこで（初回は ERG_1STP 内）設定された係数 AAT, BBT1, BBT2, CCT を用い、各 (i,k) について y 方向 1 次元の 2 本（T1 と T2）の連立三重対角系を解く。
解後に周期方向 (x,z) と壁方向 (y) のゴースト/境界セルを埋めて温度場の境界条件を整える。

## CNTDMA 
毎ステップ，前段で組み立てられた速度 RHS (FFX,FFY,FFZ) を y 方向半陰 (三重対角) 解法で解いて暫定速度場 UT を得る fractional-step 中間ステージで，続く Poisson 解 (FS2) の入力を提供する

## FS2 
fractional-step 法の圧力 Poisson ステージ：(1) 予測場 UT の発散 → (2) スペクトル×TDMA で Poisson 解 φ → (3) 勾配補正で発散フリー速度 U → (4) 一貫した半陰的圧力 P 更新 → (5) 境界再構築。
CNTDMA が作った “時間半陰(粘性 y) + 陽的非線形” 含む暫定速度を、流体力学的拘束 (∇·U=0) に投影する最終必須段階。

## TMSRSU
瞬時の速度 (u,v,w) から各 y 面での平面平均 (x,z 平均) を計算し 1 次元プロファイル AU, AV, AW, AP を得る<br>
そのプロファイルを用いて全格子点の乱流変動成分 u', v', w' を構築 (UT 配列に格納)<br>
代表 5 個の壁法線方向位置 (JA2, JB2, JC2, JD2(≒中心高さ近傍), JE2=中心) と 4 つの spanwise 位置 (z = 1/8,3/8,5/8,7/8 *幅) の組み合わせ 5×4 = 20 点で
u', v', w' をそれぞれ時間行 (1 行が 6 列: 時刻 + 5 つの y 位置) として 20 系列 (3 成分 × 4 z スライス × 5 y) に分け複数ファイルへ APPEND 出力<br>
これにより後処理で各高度・スパン位置の時間発展（統計的独立性評価 / スペクトル解析など）が可能

## TMSRST
2 つの温度（/スカラー）場 T1,T2 の x–z 平面平均（各 y）を取り瞬時の平均プロファイル EAT1(J),EAT2(J) を作る．<br>
それを用いて温度変動 T1' = T1 - <T1>_xz, T2' = T2 - <T2>_xz を生成．<br>
代表 5 つの壁法線位置 (JA2=1, JB2=16, JC2=22, JD2=36, JE2=48) と 4 つのスパン方向位置 (z = 1/8,3/8,5/8,7/8) の 20 点で時間列を継続追記出力．<br>
後処理用（例: 個別点の自相関 / スペクトル / 熱統計の収束確認）．

## ERG(PR1,PR2)
温度（ここでは 2 つのスカラー T1,T2）方程式の「陽的（AB2）部分 + y 方向以外の拡散項」を組み立てるサブルーチン．<br>
呼び出し順序: (各時間ステップの温度更新が必要なとき)<br>
ERG_1STP → CNTDMAT （初回のみ）<br>
以後は ERG → CNTDMAT のペア.<br>
ERG は 2 段階法: ERG で RHS を作り FFS1/FFS2 に格納 → CNTDMAT が y 方向 Crank–Nicolson (TDMA) で陰的項を解き T1,T2 を前進.

## STCS
メイン (ch060owv2.f) で IF (MOD(NN,500).EQ.0) のとき呼ばれ、温度場統計サンプリング周期（500ステップ毎）のコア集計ルーチン<br>
呼出直前に NSTCS = NSTCS + 1（サンプリング回数カウンタ）。STCS 自身は NSTCS を変えず、蓄積配列に“生の総和”を足していく。最終的な 1/NSTCS 正規化は別ルーチン（PNSTCS=1.0/DBLE(NSTCS) が出る後段、例: 出力/平均処理部）で実施。<br>
直後に BUDGEK1, BUDGEK2, TPOWSPE, TCORREL が呼ばれ、STCS が用意した平面平均・変動統計を使って温度フラックス／バジェット等を計算・出力。

## BUDGEK1 
第1温度スカラーの二次統計（温度分散 T'² と 3 成分の乱流熱流束 u'θ, v'θ, w'θ）の収支式に出現する全主要項（生成・輸送・分子拡散・散逸・圧力相互作用）を離散形で評価し，J ごとの累積配列へ加算するサンプリングルーチン

## BUDGEK2
第2スカラー（TG / TEM2 に格納されるパッシブスカラー）についての乱流温度分散 (T'^2/2) と 3 成分の乱流熱フラックス (u'θ, v'θ, w'θ) の各収支項（生成・拡散・散逸・圧力相関など）を壁法線方向 y ごとに蓄積

## TPOWSPE  
500 ステップ毎に，代表 11 層 y 位置で 2 つのスカラー乱れと壁法線速度乱れの（理想的には 2D FFT 後の）パワー / コスペクトルを streamwise/spanwise 方向モード別に計算し，時間方向へ累積するサブルーチン

## TCORREL 
温度 2 種の streamwise/spanwise 一次元自己相関関数 (11 y レベル) を 500 ステップ周期で蓄積するサブルーチン<br>
平均値配列 EAT* を用いて中心化し、基準列(I=1 or K=1)との相関を計算、自己分散でその場正規化後に時間累積<br>
結果は COMMON /TCOR/ の ATPC1TG (x) と ATPC3TG (z) に保持され、後段出力でサンプル数割り<br>
速度場側 CORREL の温度版に相当し、スペクトル TPOWSPE と組でスカラー空間構造統計を提供。

## AVE 
500 ステップ毎に瞬時平面統計を評価し、摩擦速度・Reynolds 応力から 4次モーメント・象限・速度勾配不変量までを総和形式で蓄積する“速度場統計のハブ”。

## BUDGET 
500 ステップごとの瞬時速度変動場を基に、乱流エネルギーおよび Reynolds 応力方程式の全主要収支項 (生成・散逸・乱流輸送・粘性拡散・圧力拡散・圧力歪・速度‐圧力勾配) を壁法線方向プロファイルとして評価し、時間総和へ蓄積するサブルーチン。正規化は行わず、後段出力で平均化される。UT は直前の AVE が与え、BUDGET の結果は他出力 (OUTPUT) の “BUDGET (K,UU,VV,WW,UV)” 項目に反映される

## POWSPE 
500 ステップ毎に選択 y 断面の (x,z) 面データから u,v,w,p と uv 共スペクトルの 1D(kx,kz) 分布を計算し，時間総和 (ASTRMG,ASPANG) に蓄積するスペクトル収集サブルーチン（最終正規化は出力段階）

## CORREL 
各選択 y 位置 (JA,JB,…,JL) で (Δx) 方向と (Δz) 方向の 1 点–ずらし点間 2 点相関係数 R(Δ)/R(0) を u,v,w, (p′) の 4 変数について蓄積 (時間平均は後段で正規化時に行う)。<br>
結果は /CORR/ の ATPC1G(IG,JG,4) (streamwise) と ATPC3G(KG,JG,4) (spanwise) に加算。

## VRTCTY 
500 ステップごとに最新の速度場から渦度（符号は逆）を計算し，各 y 面での瞬時分散（= 渦度二乗の平面平均）を時間方向に累積する統計ルーチン．結果は /VORT/ OMGG に保存され、再始動 (AVEIN/AVEOUT) と最終出力 (OUTPUT) サイクルに組み込まれる。コード全体の統計パイプラインの末尾に位置し、他統計と同じ「生加算→後正規化」方針に沿っている

## SEEDOUT 
計算終了時点の速度場と格子/条件パラメータを “二分割形式” でバイナリ出力し，後日の SEEDIN による再スタートを可能にする初期値スナップショット生成ルーチン．時間平均統計継続は別途 AVEOUT 系が担当し，SEEDOUT 自体は高速・軽量な最小限チェックポイント機能．

## TSEEDOUT は
目的: 温度場(スカラー)再開用シードデータの分割書き出し<br>
対象配列: T1, T2 （時間積分用に保持している2つの温度関連配列—現ステップ/前ステップなど）<br>
出力装置: 36–39 番ユニット<br>
36: 左半分 T1<br>
37: 右半分 T1<br>
38: 左半分 T2<br>
39: 右半分 T2<br>

## AVEOUT 
計算完了時点で速度統計の「積算生データ全体」を UNIT 11 に一括保存し，後続ジョブの AVEIN で完全復元できるようにするチェックポイント出力サブルーチン．再開後も統計が途切れないよう，全ての関係配列（平均、RMS、応力、収支、スペクトル、相関、渦度、高次モーメント、勾配不変量）とカウンタ類を順序厳守で書き出す。用途は「瞬時場」保存の SEEDOUT と補完的関係にあり，長時間統計の継続性確保が主目的

## TAVEOUT 
温度場（複数スカラー対応）時間平均統計の全積算状態（平均、RMS、熱流束、K方程式様収支、スペクトル、相関、高次・四象限統計、カウンタ）を UNIT 13 に一括保存し、TAVEIN による再開を可能にするチェックポイント出力。速度側 AVEOUT とペアで、長時間統計計測を分割ジョブ運転できる設計の要

## OUTPUT(CODE) 
速度場に関する「蓄積（積算）統計配列」を最終的な物理量（平均・RMS・収支・スペクトル・二点相関・高次統計・渦度・速度勾配不変量など）へ正規化・後処理し、テキスト (UNIT 14) へ体系的に書き出す最終レポート生成ルーチン<br>
AVEOUT が「再開用バイナリ生積算データ」を保存するのに対し、OUTPUT は人間が解析/可視化に使う整形済み統計表を出力

## TAVE_OUTPUT 
蓄積カウンタで正規化<br>
RMS, 高次モーメント, スペクトル, 2点相関, 四象限, PDF, スキューネス/フラットネスを計算<br>
境界条件パラメータ PPE2 を用いて総熱流束を補正（設定モード次第）<br>
壁座標・無次元化を行い体系的に unit 17 へ可読テキスト出力 これにより再開用の未正規化データ（TAVEOUT）と最終公開用統計（TAVE_OUTPUT）が明確に分離されている。

##  TBUD_OUTPUT 
2 つのスカラー場に対する温度分散と3方向乱流熱流束輸送方程式の各構成項（生成・散逸・乱流/分子拡散・圧力相関/圧力拡散）を、蓄積された生統計からレイノルズ数・サンプル数・面積で正規化し、残差も含め壁座標 y^+ 配列として unit 18 のテキストに体系的に出力する専用ルーチン。TAVE_OUTPUT が「総合統計一覧」、TBUD_OUTPUT が「収支方程式内訳詳細」に役割分担している

## TVEL_BACK
速度平均/RMS を温度統計と同じ時間集合で再提示する簡易ファイル<br>
スカラー主解析時に大容量の unit 14 を開かず参照できる補助アウトプット<br>
NAVE 系と NSTCS 系の正規化差異を明示的に分離するための設計<br>

## 変数
AUTUT / AUTUB: 上下壁の摩擦速度推定値の累積和（精密式）<br>
AUTUT2 / AUTUB2: 同じく摩擦速度だが簡易別式による累積<br>

## AAU, AAV, AAW, AAP 
それぞれ U, V, W, P の (x,z) 平面平均値の時間方向累積（未正規化）。NAVE 回分蓄積後に 1/NAVE を掛けて平均プロファイルを生成し、中心速度やバルク速度計算と種々の統計出力に利用される

## AURMS, AVRMS, AWRMS, APRMS 
それぞれ流速 3 成分と圧力の平面平均二乗変動量の時間累積を保持し，最終段階で平均・平方根処理を施して y 方向分布の rms プロファイル（√⟨u′²⟩ 等）として出力する配列です

## AU11(J) 〜 AU33(J)
これらは各時刻サンプリングで得られるレイノルズ応力成分（平面平均二次モーメント）を時間方向に累積する未正規化配列<br>
AU11(J): 断面平均 ⟨u′u′⟩ = ⟨u'^2⟩ の時間積算 Σ⟨u'^2⟩。<br>
AU22(J): ⟨v'^2⟩。<br>
AU33(J): ⟨w'^2⟩。<br>
AU12(J): ⟨u′v′⟩。<br>
AU13(J): ⟨u′w′⟩。<br>
AU23(J): ⟨v′w′⟩。<br>
平面平均は (x,z) に関する平均、インデックス J は壁法線方向 y の格子位置。<br>

## AAK,APk/AP11/AP12,AE*,AD*,API*,APD*,APS*,ATA*
すべて「時間方向に未正規化で加算される平面平均（x,z 平均）バジェット蓄積配列」で，出力直前に PAVE = 1/NAVE（さらに必要に応じ RE でスケール）を掛けて正規化・単位調整されます。<br>
チャンネル流（流下方向 x，壁法線 y，スパン z，唯一の平均速度勾配 dU/dy≠0）で成り立つ “一貫（consistent）形” の k および Reynolds 応力方程式の各項を保持します。

## OMG(J,1), OMG(J,2), OMG(J,3)
時間積算された平面平均渦度変動二乗 (ω'_x^2, ω'_y^2, ω'_z^2)

## SKEWUV(J),FLATUV(J) 
断面 (x,z) 平均された瞬時 u′v′ サンプルから得た Sk(u′v′) の時間積算（後で 1/NAVE を掛けて平均スキューネス）<br>
同様に (u′v′) の尖度 (kurtosis) 時間積算

## AUTRI(J,1..8) 
(x,z) 平面平均した瞬時三次（と一部四象限に関連する混合）モーメントの「時間方向未正規化蓄積配列」です。生成は SUBROUTINE AVE 内のみで行われ，ZERO で 0 初期化 → サンプリング毎に加算 → 出力直前に PAVE=1/NAVE を掛けて平均値化されます。対応はコード上で下記の局所作業配列へ加算後 (行 2480 付近) に AUTRI へ足し込まれる形です。<br>
インデックス対応<br>
1: ⟨u'^3⟩<br>
2: ⟨u'^2 v'⟩<br>
3: ⟨v'^3⟩<br>
4: ⟨w'^2 v'⟩ (出力コメント “WWV” に相当)<br>
5: ⟨u' v'^2⟩ ( “UVV” )<br>
6: ⟨u' w'^2⟩ ( “UWW” )<br>
7: ⟨w'^3⟩（出力一覧コメントには列挙されていない追加保持）<br>
8: ⟨p'^3⟩（圧力三次モーメント; 乱流圧力分布非対称性診断用）<br>

## AUQUAD(J,1..10) 
時間・面平均される 4 次（四重）モーメント（四次相関）を蓄積する配列です。定義も更新も ch060owv2.f の AVE 部分のみで行われている<br>
各インデックスの物理量（u', v', w', p' は平均からの変動）<br>
AUQUAD(J,1): ⟨u'^4⟩ (U1111)<br>
AUQUAD(J,2): ⟨u'^3 v'⟩ (U1112)<br>
AUQUAD(J,3): ⟨v'^4⟩ (U2222)<br>
AUQUAD(J,4): ⟨u' w'^2 v'⟩ (U1332) = ⟨u' v' w'^2⟩（並びはコード上の生成順）<br>
AUQUAD(J,5): ⟨u' v'^3⟩ (U1222)<br>
AUQUAD(J,6): ⟨u'^2 v'^2⟩ (U1122)<br>
AUQUAD(J,7): ⟨u'^2 w'^2⟩ (U1133)<br>
AUQUAD(J,8): ⟨v'^2 w'^2⟩ (U2233)<br>
AUQUAD(J,9): ⟨w'^4⟩ (U3333)<br>
AUQUAD(J,10): ⟨p'^4⟩ (PPPP)<br>

## AQAUV(J,1..4)
高さ J における u′v′ の象限別（Q1,Q2,Q3,Q4）の面・時間平均寄与量。

